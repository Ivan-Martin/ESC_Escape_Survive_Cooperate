<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>ESC</title>
        <script src="source/phaser3.js"></script>
        <script src="source/Generador.js"></script>
        <script src="source/Camera.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 400,
            title: 'ESC',
            version: '1.2',
            physics: {
                default: 'arcade'
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
            
        };
        
        var game = new Phaser.Game(config);

        function preload () {
            
            this.load.image('player2', 'assets/char/Placeholder2.png');
            this.load.image('player', 'assets/char/Placeholder.png');
            this.load.image('tileo', 'assets/tilemap.png');
            
        }
        
        var mapatiles;
        var tilecolision;
        var cursors;
        var player1;
        var player2;
        var capa;
        var worldsize = 20;
        var worldtiles;
        var wkey, akey, skey, dkey;
        var muros;
        var camara1;
        var camara2;
        
        function create () {
            
            
            worldtiles = worldsize*3;
            
            cursors = this.input.keyboard.createCursorKeys(); //Creamos el manejo del teclado
            wkey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
            akey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
            skey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
            dkey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
            
            mapatiles = this.make.tilemap({ tileWidth: 32, tileHeight: 32, width: worldtiles*32, heigth: worldtiles*32}); //Esto añade un mapa vacío al mundo
            
            var tileset = mapatiles.addTilesetImage('tileo', 'tileo', 32, 32); //Cargamos el mapa de sprites de tiles
            
            capa = mapatiles.createBlankDynamicLayer('nivel', tileset, 0, 0, worldtiles, worldtiles, 32, 32); //Crea una capa de worldtiles, cada tile 32x32 y la llama nivel1
            
            createworld(worldsize); //Lanzamos el generador de laberintos con un tamaño de worldsize x worldsize
            
            addloops(20);
            
            muros = tileindex(); //Recuperamos del generador de laberintos el tileo del mapa
            
            
            for (var i = 0; i < worldtiles; i++){
                for (var j = 0; j < worldtiles; j++){
                    var pos = (i*worldtiles)+j;
                    mapatiles.putTileAt(muros[pos], i, j, true, capa); //Asignamos a la capa de tiles de Phaser nuestras tiles generadas
                }
            }
            mapatiles.setCollisionBetween(3, 14, true, true, capa); //Le dice que las tiles de 3 a 14 colisionan
            
            player1 = this.physics.add.sprite(48, 48, 'player'); //Cargamos al jugador
            
            var randomx = Math.floor(Math.random() * worldsize);
            
            var randomy = Math.floor(Math.random() * worldsize);
            randomx--;
            randomy--;
            
            randomx*=32*3;
            randomy*=32*3;
            randomx+= 48;
            randomy+= 48;
            
            player2 = this.physics.add.sprite(randomx, randomy, 'player2');
            
            
            
            
            this.physics.world.enable([player1, player2]);
            //Camaras
            
            camara1 = this.cameras.main.setSize(600,400);
            camara2 = this.cameras.add(600, 0, 600, 400);
            
            camara1.setBounds(0, 0, worldtiles*32, worldtiles*32);
            camara2.setBounds(0, 0, worldtiles*32, worldtiles*32);
            
            camara1.startFollow(player1);
            camara2.startFollow(player2);
        }
        
function update () {
            
    this.physics.world.collide(player1, capa);
    //Hacemos que el personaje colisione con la capa del tile
    player1.body.velocity.x = 0;
    player1.body.velocity.y = 0;
    //El personaje por defecto aparece siempre parado excepto que se pulse una tecla
    
    this.physics.world.collide(player2, capa);
    //Hacemos que el personaje colisione con la capa del tile
    player2.body.velocity.x = 0;
    player2.body.velocity.y = 0;
    //El personaje por defecto aparece siempre parado excepto que se pulse una tecla

    if (cursors.up.isDown) {
        player1.body.velocity.y = -200;
    }
    else if (cursors.down.isDown) {
        player1.body.velocity.y = 200;
    } 
    //Manejamos las teclas arriba/abajo

    if (cursors.left.isDown)
    {
        player1.body.velocity.x = -200;
    }
    else if (cursors.right.isDown)
    {
        player1.body.velocity.x = 200;
    }
    //Manejamos las teclas izq/der
    
    if (wkey.isDown) {
        player2.body.velocity.y = -200;
    }
    else if (skey.isDown) {
        player2.body.velocity.y = 200;
    } 
    //Manejamos las teclas arriba/abajo

    if (akey.isDown)
    {
        player2.body.velocity.x = -200;
    }
    else if (dkey.isDown)
    {
        player2.body.velocity.x = 200;
    }
    //Manejamos las teclas izq/der
    
    /*
    camara1.render();
    camara2.render();
    */
    
} //Cierre de update
    };

    </script>

    </body>
</html>