<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>ESC</title>
        <script src="source/phaser3.js"></script>
        <script src="source/Generador.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 400,
            title: 'ESC',
            version: '1.2',
            physics: {
                default: 'arcade'
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
            
        };
        
        var game = new Phaser.Game(config);

        function preload () {
            
            this.load.spritesheet('player2', 'assets/char/pc2s.png', { frameWidth: 10, frameHeight: 24 });
            this.load.spritesheet('player', 'assets/char/pcs.png', { frameWidth: 10, frameHeight: 24 });
            this.load.image('tileo', 'assets/tilemap.png');
            this.load.spritesheet('powerup', 'assets/actors/ups.png', {frameWidth: 10, frameHeight: 10});
            this.load.image('borde', 'assets/actors/borde.png');
            
        }
        
         var mapatiles;
        var tilecolision;
        var cursors;
        var player1;
        var player2;
        var capa;
        var worldsize = 20;
        var centralsize = 12;
        var worldtiles;
        var wkey, akey, skey, dkey, spacekey;
        var muros;
        var camara1;
        var camara2;
        var text;
        var cuentatiempo;
        var velocidadp2;
        var powerup = false;
        var usingpower = false;
        var mask, mask2;
        
        function create () {
            
            worldtiles = worldsize*6; //Tamaño de dos laberintos
            
            worldtiles += 24; //Bordes necesarios a cada lado de la sala central
            
            worldtiles += centralsize*3; //Tamaño de la sala central
            
            console.log(worldtiles);
            
            cursors = this.input.keyboard.createCursorKeys(); //Creamos el manejo del teclado
            wkey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
            akey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
            skey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
            dkey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
            spacekey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            
            mapatiles = this.make.tilemap({ tileWidth: 32, tileHeight: 32, width: worldtiles*32, heigth: worldtiles*32}); //Esto añade un mapa vacío al mundo
            
            var tileset = mapatiles.addTilesetImage('tileo', 'tileo', 32, 32); //Cargamos el mapa de sprites de tiles
            
            capa = mapatiles.createBlankDynamicLayer('nivel', tileset, 0, 0, worldtiles, worldtiles, 32, 32); //Crea una capa de worldtiles, cada tile 32x32 y la llama nivel1
            
            createworld(worldsize); //Lanzamos el generador de laberintos con un tamaño de worldsize x worldsize
            
            addloops(5);
            
            muros = tileindex(); //Recuperamos del generador de laberintos el tileo del mapa
            
            
            for (var i = 0; i < worldsize*3; i++){
                for (var j = 0; j < worldsize*3; j++){
                    var pos = (i*worldsize*3)+j;
                    mapatiles.putTileAt(muros[pos], i, j, true, capa); //Asignamos a la capa de tiles de Phaser nuestras tiles generadas
                }
            }
            
            for (var i = 45; i < 57; i++){
                for (var j = 45, l = 0; j < 57; j++, l++){
                    mapatiles.putTileAt(1, i, l, true, capa); //Asignamos a la capa de tiles de Phaser nuestro borde
                }
            }
            
            
            createworld(centralsize); //Lanzamos el generador de laberintos con un tamaño de worldsize x worldsize
            
            muros = tileindex(); //Recuperamos del generador de laberintos el tileo del mapa
            
            
            for (var i = 57, k = 0; i < 93; i++, k++){
                for (var j = 57, l = 0; j < 93; j++, l++){
                    var pos = (k*centralsize*3)+l;
                    mapatiles.putTileAt(muros[pos], i, l, true, capa); //Asignamos a la capa de tiles de Phaser nuestras tiles generadas
                }
            }
            
            
            
            mapatiles.setCollisionBetween(3, 14, true, true, capa); //Le dice que las tiles de 3 a 14 colisionan
            
            player1 = this.physics.add.sprite(48, 48, 'player'); //Cargamos al jugador
            
            var randomx;
            var randomy;
            do{
                randomx = Math.floor(Math.random() * worldsize);
            
                randomy = Math.floor(Math.random() * worldsize);
                
                randomx--;
                randomy--;
            
                randomx*=32*3;
                randomy*=32*3;
                randomx+= 48;
                randomy+= 48;
                
            } while (randomx <= 200 || randomy <= 200);
            
            player2 = this.physics.add.sprite(randomx, randomy, 'player2');
            
            
            
            
            this.physics.world.enable([player1, player2]);
            //Camaras
            
            camara1 = this.cameras.main.setSize(600,400);
            camara2 = this.cameras.add(600, 0, 600, 400);
            
            camara1.setBounds(0, 0, worldtiles*32, worldtiles*32);
            camara2.setBounds(0, 0, worldtiles*32, worldtiles*32);
            
            camara1.startFollow(player1);
            camara2.startFollow(player2);
            
            /**/
            
            var alertar = function () { alert("Colision")};
            
            this.physics.add.collider(player1, player2, alertar, null, this);
            
            /**/
            
            var alerta2 = function () {
                alert ("Tiempo");
            }
            
            cuentatiempo = this.time.addEvent({
                delay: 180000,
                callback: alerta2,
                callbackScope: this
            });
            
            //cuentatiempo tarda 3 minutos, tiempo general de Survive, para dar victoria a p1
            
            var actualizar1 = this.time.addEvent({
                delay: 60000,
                callback: function () {
                    velocidadp2 = 200;
                },
                callbackScope: this
            });
            
            //Actualizar1 actualiza la velocidad del p2 al finalizar el primer minuto, la equipara a la de p1
            
            var actualizar2 = this.time.addEvent({
                delay: 120000,
                callback: function () {
                    velocidadp2 = 225;
                },
                callbackScope: this
            });
            
            
            
            
            
            
            var textureFrames = this.textures.get('powerup').getFrameNames();

            var animFrames = [];

            textureFrames.forEach(function (frameName) {

                animFrames.push({ key: 'powerup', frame: frameName });

            });
            
            this.anims.create({ key: 'powerupanimate', frames: animFrames, frameRate: 6, repeat: -1 });
            
            do{
                randomx = Math.floor(Math.random() * worldsize);
            
                randomy = Math.floor(Math.random() * worldsize);
                
                randomx--;
                randomy--;
            
                randomx*=32*3;
                randomy*=32*3;
                randomx+= 48;
                randomy+= 48;
                
            } while (randomx <= 200 || randomy <= 200);
            
            console.log(randomx); console.log(randomy);
            
            
            var poder = this.physics.add.sprite(randomx, randomy, 'powerup').play('powerupanimate');
            
            var getpowerup = function () {
                poder.destroy();
                powerup = true;
            }
            
            this.physics.add.collider(player1, poder, getpowerup, null, this);
            
            this.add.image(0, 0, 'borde').setScrollFactor(0);
            
            text = this.add.text(32, 32).setScrollFactor(0);
            
            /*            
            
            mask = this.make.sprite({
                x: game.config.width / 2,
                y: game.config.height / 2,
                key: 'mask',
                add: true,
                invertAlpha: true
            });
            
            mask2 = this.make.sprite({
                x: game.config.width / 2,
                y: game.config.height / 2,
                key: 'mask',
                add: true,
                invertAlpha: true
            });
            
            
            fondoneg.mask = new Phaser.Display.Masks.BitmapMask(this, mask);
            fondoneg.mask2 = new Phaser.Display.Masks.BitmapMask(this, mask2);
            
            */
        }
        
function update () {
            
    //if(!usingpower) this.physics.world.collide(player1, capa);
    //Hacemos que el personaje colisione con la capa del tile
    player1.body.velocity.x = 0;
    player1.body.velocity.y = 0;
    //El personaje por defecto aparece siempre parado excepto que se pulse una tecla
    
    this.physics.world.collide(player2, capa);
    //Hacemos que el personaje colisione con la capa del tile
    player2.body.velocity.x = 0;
    player2.body.velocity.y = 0;
    //El personaje por defecto aparece siempre parado excepto que se pulse una tecla
    

    if (cursors.up.isDown) {
        player2.body.velocity.y = -velocidadp2;
    }
    else if (cursors.down.isDown) {
        player2.body.velocity.y = velocidadp2;
    } else
    //Manejamos las teclas arriba/abajo

    if (cursors.left.isDown)
    {
        player2.body.velocity.x = -velocidadp2;
    }
    else if (cursors.right.isDown)
    {
        player2.body.velocity.x = velocidadp2;
    }
    //Manejamos las teclas izq/der
    
    if (wkey.isDown) {
        player1.body.velocity.y = -200;
    }
    else if (skey.isDown) {
        player1.body.velocity.y = 200;
    } else
    //Manejamos las teclas arriba/abajo

    if (akey.isDown)
    {
        player1.body.velocity.x = -200;
    }
    else if (dkey.isDown)
    {
        player1.body.velocity.x = 200;
    }
    //Manejamos las teclas izq/der
    
    var number = cuentatiempo.getProgress().toString().substr(2, 2);
    number = 100-number;
    
    text.setText('Tiempo: ' + number + "%");
    
    if(spacekey.isDown && powerup){
        powerup = false;
        usingpower = true;
        this.time.addEvent({
                delay: 800,
                callback: function () {
                    usingpower = false;
                },
                callbackScope: this
        });
    }
    /*
    mask.x = player1.x;
    mask.y = player1.y;
    mask2.x = player2.x;
    mask2.y = player2.y;
    */
    
} //Cierre de update
    };

    </script>

    </body>
</html>