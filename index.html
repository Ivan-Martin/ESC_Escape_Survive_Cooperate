<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>ESC</title>
        <script src="source/phaserCE.js"></script>
        <script src="source/Generador.js"></script>
        <script src="source/Camera.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(600, 400, Phaser.AUTO, 'ESC', { preload: preload, create: create, update: update });

        function preload () {
            
            game.load.image('player2', 'assets/char/Placeholder2.png');
            game.load.image('player', 'assets/char/Placeholder.png');
            game.load.image('tileo', 'assets/tilemap.png');
            
        }
        
        var mapatiles;
        var tilecolision;
        var cursors;
        var player1;
        var player2;
        var capa;
        var worldsize = 20;
        var worldtiles;
        var wkey, akey, skey, dkey;
        var muros;
        var camara1;
        var camara2;
        
        function create () {
            
            worldtiles = worldsize*3;
            
            cursors = game.input.keyboard.createCursorKeys(); //Creamos el manejo del teclado
            wkey = game.input.keyboard.addKey(Phaser.Keyboard.W);
            akey = game.input.keyboard.addKey(Phaser.Keyboard.A);
            skey = game.input.keyboard.addKey(Phaser.Keyboard.S);
            dkey = game.input.keyboard.addKey(Phaser.Keyboard.D);
            
            game.stage.backgroundColor = '#2d2d2d'; //Ponemos un color gris de fondo por si algo falla
            
            mapatiles = game.add.tilemap(); //Esto añade un mapa vacío al mundo
            
            mapatiles.addTilesetImage('tileo'); //Cargamos el mapa de sprites de tiles
            
            capa = mapatiles.create('nivel', worldtiles, worldtiles, 32, 32); //Crea una capa de worldtiles, cada tile 32x32 y la llama nivel1
            capa.resizeWorld(); //Hace que el mundo sea del mismo tamaño que nuestra capa
            
            createworld(worldsize); //Lanzamos el generador de laberintos con un tamaño de worldsize x worldsize
            
            addloops(20);
            
            muros = tileindex(); //Recuperamos del generador de laberintos el tileo del mapa
            
            for (var i = 0; i < worldtiles; i++){
                for (var j = 0; j < worldtiles; j++){
                    var pos = (i*worldtiles)+j;
                    mapatiles.putTile(muros[pos], i, j, capa); //Asignamos a la capa de tiles de Phaser nuestras tiles generadas
                }
            }
            mapatiles.setCollisionBetween(3, 14, true, capa, true); //Le dice que las tiles de 3 a 14 colisionan
            
            game.physics.startSystem(Phaser.Physics.ARCADE); //Inicializamos el sistema de físicas para colisionar
            
            player1 = game.add.sprite(32, 32, 'player'); //Cargamos al jugador
            
            game.physics.arcade.enable(player1); //Permitimos que interaccione con las físicas
            player1.body.collideWorldBounds = true; //Para que no se salga de la pantalla
            
            
            game.camera.follow(player1);
            game.camera.deadzone = new Phaser.Rectangle(100, 100, 400, 200);
            //Hacemos que la cámara siga al jugador y se mueva por el mundo cuando el jugador se acerque a los límites
            
            
            player2 = game.add.sprite(64, 64, 'player2');
            game.physics.arcade.enable(player2); //Permitimos que interaccione con las físicas
            player2.body.collideWorldBounds = true; //Para que no se salga de la pantalla
            
            
            
            //Camaras
            
            /*
            
              // Create world stage, DON'T add it to the game's stage or world group
            var worldStage = new Phaser.Group(game, null);
            
            camara1 = new Camera(game, 600, 400, 0, 0, 600, 400);
            game.world.addChild(camara1.view);
            
            camara2 = new Camera(game, 600, 400, 600, 0, 600, 400);
            game.world.addChild(camara2.view);
            
            camara1.bounds.width = 600;
            camara1.bounds.height = 400;
            
            camara2.bounds.width = 600;
            camara2.bounds.height = 400;
            
            // Set display target of the camera to the world stage
            camara1.setDisplayTarget(worldStage);
            camara2.setDisplayTarget(worldStage);
            */
        }
        
function update () {
            
    game.physics.arcade.collide(player1, capa);
    //Hacemos que el personaje colisione con la capa del tile
    player1.body.velocity.x = 0;
    player1.body.velocity.y = 0;
    //El personaje por defecto aparece siempre parado excepto que se pulse una tecla
    
    game.physics.arcade.collide(player2, capa);
    //Hacemos que el personaje colisione con la capa del tile
    player2.body.velocity.x = 0;
    player2.body.velocity.y = 0;
    //El personaje por defecto aparece siempre parado excepto que se pulse una tecla

    if (cursors.up.isDown) {
        player1.body.velocity.y = -200;
        //camara1.move(0, -20);
    }
    else if (cursors.down.isDown) {
        player1.body.velocity.y = 200;
        //camara1.move(0, 20);
    }
    //Manejamos las teclas arriba/abajo

    if (cursors.left.isDown)
    {
        player1.body.velocity.x = -200;
        //camara1.move(-20, 0);
    }
    else if (cursors.right.isDown)
    {
        player1.body.velocity.x = 200;
        //camara1.move(20, 0);
    }
    //Manejamos las teclas izq/der
    
    if (wkey.isDown) {
        player2.body.velocity.y = -200;
    }
    else if (skey.isDown) {
        player2.body.velocity.y = 200;
    }
    //Manejamos las teclas arriba/abajo

    if (akey.isDown)
    {
        player2.body.velocity.x = -200;
    }
    else if (dkey.isDown)
    {
        player2.body.velocity.x = 200;
    }
    //Manejamos las teclas izq/der
    
    /*
    camara1.render();
    camara2.render();
    */
    
} //Cierre de update
    };

    </script>

    </body>
</html>